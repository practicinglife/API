<Window x:Class="MspTools.App.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d"
        Title="MSP Tools – Multi-Platform Integration"
        Height="800" Width="1280"
        MinHeight="600" MinWidth="900"
        Background="{StaticResource BackgroundBrush}"
        WindowStartupLocation="CenterScreen">

    <Grid>
        <Grid.RowDefinitions>
            <!-- Header bar -->
            <RowDefinition Height="56"/>
            <!-- Tab bar -->
            <RowDefinition Height="44"/>
            <!-- Content -->
            <RowDefinition Height="*"/>
            <!-- Status bar -->
            <RowDefinition Height="28"/>
        </Grid.RowDefinitions>

        <!-- ═══════════════════════════════════════════════ Header ═════════════════════════════════════════════════ -->
        <Border Grid.Row="0" Background="{StaticResource PrimaryBrush}">
            <Grid Margin="20,0">
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                    <TextBlock Text="⚙" FontSize="24" Foreground="White" VerticalAlignment="Center" Margin="0,0,10,0"/>
                    <TextBlock Text="MSP Tools" FontSize="22" FontWeight="Bold" Foreground="White" VerticalAlignment="Center"/>
                    <TextBlock Text="Multi-Platform Integration Hub" FontSize="12" Foreground="#A8C8E8"
                               VerticalAlignment="Center" Margin="12,4,0,0"/>
                </StackPanel>
                <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center" Spacing="8">
                    <Button Content="Sync All" Style="{StaticResource PrimaryButton}"
                            Command="{Binding SyncAllCommand}"
                            IsEnabled="{Binding IsNotBusy}"
                            ToolTip="Fetch data from all enabled connections"/>
                    <Button Content="Compute Matches" Style="{StaticResource SecondaryButton}"
                            Command="{Binding ComputeMatchesCommand}"
                            IsEnabled="{Binding IsNotBusy}"
                            ToolTip="Find the same assets across platforms"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- ═══════════════════════════════════════════════ Tab bar ════════════════════════════════════════════════ -->
        <Border Grid.Row="1" Background="{StaticResource SurfaceBrush}"
                BorderBrush="#E5E7EB" BorderThickness="0,0,0,1">
            <StackPanel Orientation="Horizontal" Margin="20,0">
                <RadioButton Content="Connections" Style="{StaticResource {x:Type RadioButton}}"
                             GroupName="Tabs" IsChecked="{Binding ShowConnections}"
                             Cursor="Hand" FontWeight="SemiBold" Margin="0,0,24,0"
                             VerticalAlignment="Center"/>
                <RadioButton Content="Devices" GroupName="Tabs"
                             IsChecked="{Binding ShowDevices}"
                             Cursor="Hand" FontWeight="SemiBold" Margin="0,0,24,0"
                             VerticalAlignment="Center"/>
                <RadioButton Content="Companies" GroupName="Tabs"
                             IsChecked="{Binding ShowCompanies}"
                             Cursor="Hand" FontWeight="SemiBold" Margin="0,0,24,0"
                             VerticalAlignment="Center"/>
                <RadioButton Content="Matches" GroupName="Tabs"
                             IsChecked="{Binding ShowMatches}"
                             Cursor="Hand" FontWeight="SemiBold"
                             VerticalAlignment="Center"/>
            </StackPanel>
        </Border>

        <!-- ═══════════════════════════════════════════════ Content area ══════════════════════════════════════════ -->
        <Grid Grid.Row="2" Margin="20,16">

            <!-- CONNECTIONS TAB -->
            <Grid Visibility="{Binding ConnectionsVisibility}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="Auto"/>
                </Grid.RowDefinitions>

                <TextBlock Grid.Row="0" Text="API Connections" FontSize="18" FontWeight="Bold"
                           Foreground="{StaticResource TextPrimaryBrush}" Margin="0,0,0,12"/>

                <DataGrid Grid.Row="1" ItemsSource="{Binding Connections}">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Name" Binding="{Binding Name}" Width="200"/>
                        <DataGridTextColumn Header="Platform" Binding="{Binding ConnectorType}" Width="160"/>
                        <DataGridTextColumn Header="Base URL" Binding="{Binding BaseUrl}" Width="*"/>
                        <DataGridCheckBoxColumn Header="Enabled" Binding="{Binding IsEnabled}" Width="70"/>
                        <DataGridTextColumn Header="Last Sync" Binding="{Binding LastSyncUtc, StringFormat='{}{0:g}'}" Width="140"/>
                        <DataGridTemplateColumn Header="Actions" Width="160">
                            <DataGridTemplateColumn.CellTemplate>
                                <DataTemplate>
                                    <StackPanel Orientation="Horizontal" Spacing="6" Margin="4,2">
                                        <Button Content="Test" Style="{StaticResource PrimaryButton}"
                                                Padding="8,4" FontSize="11"
                                                Command="{Binding DataContext.TestConnectionCommand,
                                                          RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                CommandParameter="{Binding}"/>
                                        <Button Content="Remove" Style="{StaticResource SecondaryButton}"
                                                Padding="8,4" FontSize="11"
                                                Command="{Binding DataContext.RemoveConnectionCommand,
                                                          RelativeSource={RelativeSource AncestorType=DataGrid}}"
                                                CommandParameter="{Binding}"/>
                                    </StackPanel>
                                </DataTemplate>
                            </DataGridTemplateColumn.CellTemplate>
                        </DataGridTemplateColumn>
                    </DataGrid.Columns>
                </DataGrid>

                <!-- Add connection form -->
                <Border Grid.Row="2" Style="{StaticResource CardBorder}" Margin="0,16,0,0">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="8"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>

                        <TextBlock Grid.ColumnSpan="5" Text="Add New Connection"
                                   FontWeight="SemiBold" Margin="0,0,0,8"/>

                        <StackPanel Grid.Row="2" Grid.Column="0" Margin="0,0,8,0">
                            <TextBlock Text="Connection Name" FontSize="11" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,0,4"/>
                            <TextBox Text="{Binding NewConnection.Name, UpdateSourceTrigger=PropertyChanged}"
                                     PlaceholderText="My ConnectWise Manage"/>
                        </StackPanel>

                        <StackPanel Grid.Row="2" Grid.Column="1" Margin="0,0,8,0">
                            <TextBlock Text="Platform" FontSize="11" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,0,4"/>
                            <ComboBox ItemsSource="{Binding ConnectorTypes}"
                                      SelectedItem="{Binding NewConnection.ConnectorType}"/>
                        </StackPanel>

                        <StackPanel Grid.Row="2" Grid.Column="2" Margin="0,0,8,0">
                            <TextBlock Text="Base URL" FontSize="11" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,0,4"/>
                            <TextBox Text="{Binding NewConnection.BaseUrl, UpdateSourceTrigger=PropertyChanged}"
                                     PlaceholderText="https://na.myconnectwise.net/v4_6_release/apis/3.0"/>
                        </StackPanel>

                        <StackPanel Grid.Row="2" Grid.Column="3" Margin="0,0,8,0">
                            <TextBlock Text="Auth Type" FontSize="11" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,0,4"/>
                            <ComboBox ItemsSource="{Binding AuthMethodTypes}"
                                      SelectedItem="{Binding NewConnection.SelectedAuthType}"/>
                        </StackPanel>

                        <Button Grid.Row="2" Grid.Column="4"
                                Content="Configure &amp; Add"
                                Style="{StaticResource PrimaryButton}"
                                VerticalAlignment="Bottom"
                                Command="{Binding OpenAddConnectionDialogCommand}"/>
                    </Grid>
                </Border>
            </Grid>

            <!-- DEVICES TAB -->
            <Grid Visibility="{Binding DevicesVisibility}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Search bar -->
                <Border Grid.Row="0" Style="{StaticResource CardBorder}" Margin="0,0,0,12">
                    <StackPanel>
                        <TextBlock Text="Search Devices" FontWeight="SemiBold" Margin="0,0,0,8"/>
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel Grid.Column="0" Margin="0,0,8,0">
                                <TextBlock Text="Computer Name" FontSize="11" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,0,4"/>
                                <TextBox Text="{Binding DeviceSearch.ComputerName, UpdateSourceTrigger=PropertyChanged}"
                                         PlaceholderText="Filter by computer name…"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Margin="0,0,8,0">
                                <TextBlock Text="Agent Name" FontSize="11" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,0,4"/>
                                <TextBox Text="{Binding DeviceSearch.AgentName, UpdateSourceTrigger=PropertyChanged}"
                                         PlaceholderText="Filter by agent name…"/>
                            </StackPanel>
                            <StackPanel Grid.Column="2" Margin="0,0,8,0">
                                <TextBlock Text="Company Name" FontSize="11" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,0,4"/>
                                <TextBox Text="{Binding DeviceSearch.CompanyName, UpdateSourceTrigger=PropertyChanged}"
                                         PlaceholderText="Filter by company…"/>
                            </StackPanel>
                            <StackPanel Grid.Column="3" Margin="0,0,8,0">
                                <TextBlock Text="Site Name" FontSize="11" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,0,4"/>
                                <TextBox Text="{Binding DeviceSearch.SiteName, UpdateSourceTrigger=PropertyChanged}"
                                         PlaceholderText="Filter by site…"/>
                            </StackPanel>
                            <Button Grid.Column="4" Content="Search" Style="{StaticResource PrimaryButton}"
                                    VerticalAlignment="Bottom"
                                    Command="{Binding SearchDevicesCommand}"/>
                        </Grid>
                    </StackPanel>
                </Border>

                <DataGrid Grid.Row="1" ItemsSource="{Binding FilteredDevices}">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Computer Name" Binding="{Binding ComputerName}" Width="180"/>
                        <DataGridTextColumn Header="Agent Name" Binding="{Binding AgentName}" Width="160"/>
                        <DataGridTextColumn Header="Company" Binding="{Binding CompanyName}" Width="160"/>
                        <DataGridTextColumn Header="Site" Binding="{Binding SiteName}" Width="130"/>
                        <DataGridTextColumn Header="Platform" Binding="{Binding SourcePlatform}" Width="200"/>
                        <DataGridTextColumn Header="OS" Binding="{Binding OperatingSystem}" Width="130"/>
                        <DataGridTextColumn Header="IP Address" Binding="{Binding IpAddress}" Width="120"/>
                        <DataGridCheckBoxColumn Header="Online" Binding="{Binding IsOnline}" Width="60"/>
                        <DataGridTextColumn Header="Last Seen" Binding="{Binding LastSeenUtc, StringFormat='{}{0:g}'}" Width="130"/>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>

            <!-- COMPANIES TAB -->
            <Grid Visibility="{Binding CompaniesVisibility}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <Border Grid.Row="0" Style="{StaticResource CardBorder}" Margin="0,0,0,12">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <StackPanel Grid.Column="0" Margin="0,0,8,0">
                            <TextBlock Text="Company Name" FontSize="11" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,0,4"/>
                            <TextBox Text="{Binding CompanySearch.CompanyName, UpdateSourceTrigger=PropertyChanged}"
                                     PlaceholderText="Filter by company name…"/>
                        </StackPanel>
                        <StackPanel Grid.Column="1" Margin="0,0,8,0">
                            <TextBlock Text="Site Name" FontSize="11" Foreground="{StaticResource TextSecondaryBrush}" Margin="0,0,0,4"/>
                            <TextBox Text="{Binding CompanySearch.SiteName, UpdateSourceTrigger=PropertyChanged}"
                                     PlaceholderText="Filter by site name…"/>
                        </StackPanel>
                        <Button Grid.Column="2" Content="Search" Style="{StaticResource PrimaryButton}"
                                VerticalAlignment="Bottom"
                                Command="{Binding SearchCompaniesCommand}"/>
                    </Grid>
                </Border>

                <DataGrid Grid.Row="1" ItemsSource="{Binding FilteredCompanies}">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Company Name" Binding="{Binding CompanyName}" Width="220"/>
                        <DataGridTextColumn Header="Identifier" Binding="{Binding CompanyIdentifier}" Width="130"/>
                        <DataGridTextColumn Header="Platform" Binding="{Binding SourcePlatform}" Width="200"/>
                        <DataGridTextColumn Header="City" Binding="{Binding City}" Width="120"/>
                        <DataGridTextColumn Header="State" Binding="{Binding State}" Width="80"/>
                        <DataGridTextColumn Header="Sites" Binding="{Binding SiteCount}" Width="70"/>
                        <DataGridTextColumn Header="Phone" Binding="{Binding PhoneNumber}" Width="130"/>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>

            <!-- MATCHES TAB -->
            <Grid Visibility="{Binding MatchesVisibility}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <Border Grid.Row="0" Style="{StaticResource CardBorder}" Margin="0,0,0,12">
                    <StackPanel Orientation="Horizontal" Spacing="16">
                        <TextBlock VerticalAlignment="Center" FontWeight="SemiBold">Cross-Platform Matches</TextBlock>
                        <TextBlock VerticalAlignment="Center" Foreground="{StaticResource TextSecondaryBrush}">
                            <Run Text="{Binding Matches.Count, Mode=OneWay}"/>
                            <Run Text="matches found across connected platforms"/>
                        </TextBlock>
                        <Button Content="Recompute" Style="{StaticResource PrimaryButton}"
                                Command="{Binding ComputeMatchesCommand}"/>
                    </StackPanel>
                </Border>

                <DataGrid Grid.Row="1" ItemsSource="{Binding Matches}">
                    <DataGrid.Columns>
                        <DataGridTextColumn Header="Match Key" Binding="{Binding MatchKey}" Width="200"/>
                        <DataGridTextColumn Header="Match Type" Binding="{Binding MatchType}" Width="120"/>
                        <DataGridTextColumn Header="Matched Devices" Binding="{Binding DeviceCount}" Width="130"/>
                        <DataGridTextColumn Header="Matched Companies" Binding="{Binding CompanyCount}" Width="150"/>
                        <DataGridTextColumn Header="Confidence" Binding="{Binding ConfidenceScore, StringFormat=P0}" Width="100"/>
                        <DataGridTextColumn Header="Platforms" Binding="{Binding PlatformList}" Width="*"/>
                        <DataGridTextColumn Header="Matched At" Binding="{Binding MatchedAtUtc, StringFormat='{}{0:g}'}" Width="130"/>
                    </DataGrid.Columns>
                </DataGrid>
            </Grid>
        </Grid>

        <!-- ═══════════════════════════════════════════════ Status bar ════════════════════════════════════════════ -->
        <Border Grid.Row="3" Background="{StaticResource PrimaryBrush}" Padding="16,0">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <TextBlock Text="{Binding StatusMessage}" Foreground="#A8C8E8"
                           VerticalAlignment="Center" FontSize="11"/>
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="12" VerticalAlignment="Center">
                    <TextBlock Foreground="#A8C8E8" FontSize="11">
                        <Run Text="{Binding Devices.Count, Mode=OneWay}"/>
                        <Run Text="devices |"/>
                        <Run Text="{Binding Companies.Count, Mode=OneWay}"/>
                        <Run Text="companies |"/>
                        <Run Text="{Binding Connections.Count, Mode=OneWay}"/>
                        <Run Text="connections"/>
                    </TextBlock>
                    <ProgressBar Width="120" Height="8" IsIndeterminate="{Binding IsBusy}"
                                 Visibility="{Binding BusyVisibility}" Foreground="{StaticResource AccentBrush}"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</Window>
